<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Integration Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'JetBrains Mono', monospace;
        }

        .json-card:hover {
            border-color: #4ade80;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen">

    <nav
        class="border-b border-slate-800 p-4 flex justify-between items-center bg-slate-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <h1 class="text-xl font-bold tracking-tighter tracking-widest text-white">NEXUS_<span
                    class="text-green-500">HUB</span></h1>
        </div>
        <div class="text-xs text-slate-500">v1.0.0 | System Status: <span class="text-green-400">Online</span></div>
    </nav>

    <main class="max-w-6xl mx-auto p-6">
        <header class="mb-8">
            <h2 class="text-slate-400 text-sm mb-1 uppercase tracking-widest">Live Integration Feed</h2>
            <p class="text-2xl font-semibold text-white">Capturando peticiones entrantes...</p>
        </header>

        <div id="webhook-container" class="space-y-4">
            <div class="p-8 border border-dashed border-slate-800 rounded-xl text-center text-slate-600">
                Esperando el primer Webhook... envía un POST a <code
                    class="bg-slate-800 text-slate-300 px-2 py-1 rounded">/webhook</code>
            </div>
        </div>
    </main>

    <script>
        const container = document.getElementById('webhook-container');
        const socket = new WebSocket(`ws://${window.location.host}/ws`);

        // Función única para crear la interfaz de cada tarjeta
        function createCard(data) {
            const card = document.createElement('div');
            // Diseño moderno con borde verde para resaltar el éxito de la captura
            card.className = "bg-slate-900 border border-slate-800 p-5 rounded-xl mb-4 border-l-4 border-l-green-500 shadow-lg animate-in fade-in duration-500 hover:border-green-400/50 transition-all";

            card.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <span class="bg-green-500/20 text-green-400 text-xs font-bold px-2 py-1 rounded border border-green-500/30">
                    ${data.method}
                </span>
                <span class="text-slate-500 text-xs font-mono tracking-tight">ID: #${data.id} | ${data.time}</span>
            </div>
            <div class="bg-black/40 p-3 rounded-lg border border-slate-800">
                <pre class="text-sm text-blue-300 font-mono overflow-x-auto scrollbar-hide"><code>${JSON.stringify(data.payload, null, 2)}</code></pre>
            </div>
        `;
            return card;
        }

        // 1. CARGA INICIAL: Traemos los últimos 10 webhooks de la base de datos SQLite
        fetch('/api/history')
            .then(response => response.json())
            .then(events => {
                if (events.length > 0) {
                    container.innerHTML = ''; // Limpiamos el mensaje de "Esperando..."
                    // Los insertamos en orden para que el más nuevo quede arriba
                    events.forEach(event => {
                        container.appendChild(createCard(event));
                    });
                }
            })
            .catch(err => console.error("Error cargando historial:", err));

        // 2. TIEMPO REAL: Escuchamos nuevos eventos vía WebSocket
        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log("Nuevo webhook detectado:", data);

            if (container.innerHTML.includes('Esperando')) {
                container.innerHTML = '';
            }

            // Insertamos la nueva tarjeta al principio de la lista
            container.prepend(createCard(data));
        };

        socket.onopen = () => console.log("Nexus conectado y escuchando...");
        socket.onerror = (error) => console.error("Error de conexión WebSocket:", error);
    </script>
</body>

</html>